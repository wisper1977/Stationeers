# Alias assignments
alias trans d0     # Transmitter (sends the final averaged data)
alias rec1 d1      # Receiver 1
alias rec2 d2      # Receiver 2
alias rec3 d3      # Receiver 3
alias rec4 d4      # Receiver 4
alias led d5       # LED display

# Main loop
main:

# Initialize sum and count
set r4 0  # Sum of valid values
set r5 0  # Count of active sources (local + receivers)

# Read local battery ratio
lb r0 -1388288459 Ratio Average
breqz r0 skip_local  # If no local batteries are found, skip
add r4 r4 r0
add r5 r5 1
skip_local:

# Read values from all four receivers and count active ones
l r1 rec1 Setting
breqz r1 skip1
add r4 r4 r1
add r5 r5 1
skip1:

l r2 rec2 Setting
breqz r2 skip2
add r4 r4 r2
add r5 r5 1
skip2:

l r3 rec3 Setting
breqz r3 skip3
add r4 r4 r3
add r5 r5 1
skip3:

l r6 rec4 Setting
breqz r6 skip4
add r4 r4 r6
add r5 r5 1
skip4:

# Check if we have at least one active source to avoid division by zero
breqz r5 no_data

# Compute the average (sum / count of active sources)
div r7 r4 r5
j transmit

# Handle case where no batteries or receivers are active
no_data:
set r7 0  # Set average to 0 if no devices are providing data

# Transmit the averaged value
transmit:
a trans Setting r7

# Display the averaged value on the LED
s led Setting r7

# Loop back to main
j main
