# Main Battery Controller (Handles Multiple Battery Types)
# Alias assignments
alias trans d0      # Transmitter to send the final averaged data
alias rec1 d1       # Receiver 1
alias rec2 d2       # Receiver 2
alias rec3 d3       # Receiver 3
alias rec4 d4       # Receiver 4
alias led d5        # LED to display the average

# Register aliases
alias device r0     # Current battery index (0-5 for devices)
alias batteryType1 r6  # First battery hash type
alias batteryType2 r7  # Second battery hash type
alias sumRatios r8    # Sum of ratios from active batteries
alias activeCount r9  # Count of active batteries

# Define the hashes for different battery types
set batteryType1 -1388288459  # Example hash for the first type
set batteryType2 -400115994   # Correct hash for the second type

# Main loop
start:
set device 0       # Start with the first battery
set sumRatios 0    # Reset sum of ratios
set activeCount 0  # Reset active battery count

# Loop to check and sum ratios for all batteries
loop:
slt r10 device 6  # Check if device < 6 (max 6 batteries)
blez r10 done     # Exit loop if device >= 6

bdns dr0 skip     # Skip if device is not assigned
l r11 dr0 Hash    # Get the hash of the current battery

# Check if the battery type matches either of the defined hashes
beq r11 batteryType1 skip   # Skip if it is not the first battery type
beq r11 batteryType2 skip   # Skip if it is not the second battery type

# If battery type matches, sum the ratio and count the active device
lb r12 dr0 Ratio Average   # Get the battery's ratio
add sumRatios sumRatios r12  # Add to the sum
add activeCount activeCount 1  # Increment active count

skip:
add device device 1        # Move to the next battery
j loop                    # Repeat loop

# Done processing batteries
done:
breqz activeCount no_data  # If no active batteries, skip average calculation

# Calculate the average ratio (sum / count)
div r13 sumRatios activeCount  # r13 = sumRatios / activeCount
j transmit                    # Send the result

# Handle no active batteries
no_data:
set r13 0   # Set average to 0 if no active batteries

# Transmit the average ratio
transmit:
a trans Setting r13   # Send the average ratio to transmitter

# Display the average ratio on the LED
s led Setting r13     # Update the LED display with the average

# Yield and restart the process
yield
j start
